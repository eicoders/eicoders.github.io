<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jar Ledger</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#0078D4',
                        'primary-light': '#31A1E0',
                        'secondary': '#f3f4f6',
                        'accent': '#107c10',
                        'accent-light': '#18b518',
                        'danger': '#dc2626',
                        'background-light': '#ffffff',
                        'primary-dark': '#005a9e',
                        'black-text': '#111827',
                        'border-gray': '#e5e7eb',
                        'google-red': '#db4437',
                        'google-red-dark': '#c33023',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <script>
        (function() {
            function applyTheme(theme) {
                if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);
        })();
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .history-list { max-height: 400px; overflow-y: auto; border-radius: 0.5rem; }
        .corporate-card-pro { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05); }
        .net-balance-highlight { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); transform: scale(1.01); transition: transform 0.2s; }
        .circular-button { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; box-shadow: 0 6px 10px -1px rgba(0, 0, 0, 0.15), 0 3px 6px -2px rgba(0, 0, 0, 0.1); }
        .client-action-disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(100%); box-shadow: none !important; }
        .search-input-container input { padding-left: 2.5rem; }
        .search-icon { position: absolute; top: 50%; left: 0.75rem; transform: translateY(-50%); color: #6b7280; }
        .google-btn { background-color: #db4437; color: white; display: flex; align-items: center; justify-content: center; }
        .google-btn:hover { background-color: #c33023; }
        .google-icon { width: 20px; height: 20px; margin-right: 12px; }
        #auth-modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        #profile-dropdown { position: absolute; top: 110%; right: 0; width: 250px; z-index: 60; overflow: hidden; }
        #scroll-to-top { position: fixed; bottom: 20px; right: 20px; display: none; z-index: 30; }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 6px 0px rgba(0, 120, 212, 0.5); transform: scale(1); } 50% { box-shadow: 0 0 16px 4px rgba(0, 120, 212, 0.8); transform: scale(1.02); } }
        #theme-toggle-btn { border-radius: 0.5rem; animation: pulse-glow 2.5s infinite ease-in-out; }
    </style>
</head>

<body class="bg-background-light dark:bg-[#1A1D21]">

<header id="main-header" class="fixed top-0 left-0 right-0 z-40 bg-background-light shadow-md dark:bg-[#1A1D21] dark:border-b dark:border-[#3A404A]">
    <div class="max-w-6xl mx-auto flex justify-between items-center p-6">
        <h1 class="text-3xl font-extrabold text-black-text tracking-tight uppercase dark:text-[#EAEAEA]">
            Jar Fanmade
        </h1>
        <div id="user-action-container" class="relative z-50">
            <button id="user-action-button" class="circular-button transition duration-150 transform hover:scale-110 focus:ring-4 text-gray-700 dark:text-[#EAEAEA] bg-white dark:bg-[#3A404A]">
                <svg id="user-action-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
            </button>
            <div id="profile-dropdown" style="display: none;" class="bg-white border border-gray-100 rounded-xl shadow-lg dark:bg-[#252A31] dark:border-[#3A404A]">
                <div class="p-4 border-b border-gray-200 dark:border-[#3A404A]">
                    <p class="text-sm text-gray-500 dark:text-[#9A9A9A]">Signed in as:</p>
                    <p id="user-email-display" class="text-base font-semibold text-black-text dark:text-[#EAEAEA] truncate">user@example.com</p>
                </div>
                <div class="p-2 border-b border-gray-200 dark:border-[#3A404A]">
                    <p class="text-xs font-semibold text-gray-400 dark:text-[#7A7A7A] px-2 pt-1">Theme</p>
                    <div class="p-1">
                        <button id="theme-toggle-btn" class="w-full flex justify-center items-center gap-2 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#3A404A] text-gray-700 dark:text-[#EAEAEA]">
                            <svg id="theme-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"></svg>
                            <span id="theme-toggle-text" class="text-sm font-semibold"></span>
                        </button>
                    </div>
                </div>
                <button id="dropdown-logout-btn" class="w-full text-left px-4 py-3 text-sm text-danger font-semibold hover:bg-red-50 dark:hover:bg-[#3A404A] transition duration-150 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H3" />
                    </svg>
                    Log Out
                </button>
            </div>
        </div>
    </div>
</header>

<div id="auth-modal-backdrop" style="display: none;">
    <div id="auth-container" class="w-full max-w-lg p-8 bg-white rounded-xl corporate-card-pro space-y-5 dark:bg-[#252A31] dark:border-[#3A404A]" onclick="event.stopPropagation();">
        <div class="flex justify-between items-center">
            <h2 id="auth-title" class="text-2xl font-bold text-primary dark:text-primary-light">Cloud Ledger Login</h2>
            <button onclick="hideAuthModal()" class="text-gray-400 hover:text-gray-600 dark:text-[#9A9A9A] dark:hover:text-[#EAEAEA]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <button onclick="signInWithGoogle()" class="w-full google-btn font-bold py-3 rounded-lg shadow-md transition duration-150 primary-action-btn">
            <svg class="google-icon" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                <g fill="none" fill-rule="evenodd">
                    <path d="M17.64 9.2045c0-.6381-.0573-1.2518-.1698-1.8409H9v3.4818h4.8436c-.2086 1.125-.8427 2.0782-1.7959 2.7164v2.26h2.9082c1.7018-1.5668 2.68-3.8732 2.68-6.6191z" fill="#4285F4"/>
                    <path d="M9 18c2.43 0 4.47-.8032 5.96-2.1764L12.0518 13.56c-.8032.5409-1.8395.8618-3.0518.8618-2.3441 0-4.3282-1.5818-5.0359-3.7109H.9v2.33C2.3909 15.9832 5.4282 18 9 18z" fill="#34A853"/>
                    <path d="M3.9641 10.71c-.1818-.5409-.2836-1.1164-.2836-1.71s.1018-1.1691.2836-1.71V4.95H.9C.3273 6.1364 0 7.5232 0 9s.3273 2.8636.9 4.05l3.0641-2.33z" fill="#FBBC05"/>
                    <path d="M9 3.5782c1.3236 0 2.5082.4555 3.4409 1.3536l2.5809-2.5809C13.46.8559 11.4236 0 9 0 5.4282 0 2.3909 2.0168.9 5.04L3.9641 7.37c.7077-2.1291 2.6918-3.7918 5.0359-3.7918z" fill="#EA4335"/>
                </g>
            </svg>
            Sign in with Google
        </button>
        <div class="flex items-center space-x-2">
            <hr class="flex-grow border-gray-300 dark:border-[#4A505A]">
            <span class="text-gray-500 dark:text-[#9A9A9A] text-sm">OR</span>
            <hr class="flex-grow border-gray-300 dark:border-[#4A505A]">
        </div>
        <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 border rounded-lg focus:border-primary focus:ring-1 focus:ring-primary transition duration-150 bg-white border-gray-300 dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]">
        <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 border rounded-lg focus:border-primary focus:ring-1 focus:ring-primary transition duration-150 bg-white border-gray-300 dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]">
        <button id="auth-submit-btn" class="w-full bg-primary text-white font-bold py-3 rounded-lg shadow-md hover:bg-primary-dark transition duration-150 primary-action-btn">
            Log In
        </button>
        <p class="text-center text-sm text-gray-600 dark:text-[#9A9A9A]">
            <span id="auth-toggle-text">Need an account?</span>
            <button id="auth-toggle-link" class="font-semibold text-primary hover:underline dark:text-primary-light">
                Sign Up
            </button>
        </p>
    </div>
</div>

<div id="app" class="max-w-6xl mx-auto space-y-10 p-6 md:p-10" style="padding-top: 120px;">

    <div id="app-content-area" style="display: block;">

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

            <div id="select-client-card" class="lg:col-span-2 bg-white p-6 rounded-xl corporate-card-pro dark:bg-[#252A31] dark:border-[#3A404A]">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-3 dark:text-[#EAEAEA] dark:border-[#3A404A]">üîç Select Active Client</h2>
                <label for="client-search-input" class="block text-sm font-medium text-gray-600 mb-1 dark:text-[#9A9A9A]">Search/Filter Client</label>
                <div class="search-input-container relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 search-icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                    <input type="text" id="client-search-input" placeholder="Type name to search..." class="mb-4 block w-full rounded-lg border-gray-300 shadow-sm p-3 transition duration-150 dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]">
                </div>
                <label for="client-selector" class="block text-sm font-medium text-gray-600 mb-1 dark:text-[#9A9A9A]">Active Client</label>
                <select id="client-selector" class="block w-full rounded-lg border-gray-300 shadow-sm p-3 bg-white font-semibold transition duration-150 dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA]"></select>
            </div>

            <div id="new-client-card" class="bg-white p-6 rounded-xl corporate-card-pro flex flex-col justify-between dark:bg-[#252A31] dark:border-[#3A404A]">
                <h2 class="text-xl font-bold text-primary mb-4 border-b border-primary/20 pb-3 dark:text-primary-light dark:border-primary/30">‚ûï New Client Setup</h2>
                <p class="text-sm text-gray-600 mb-4 dark:text-[#9A9A9A]">Create a new ledger and set a default hourly rate for a new client.</p>
                <button id="add-new-client-btn" class="w-full bg-primary text-white font-semibold py-3 px-4 rounded-lg shadow-xl hover:bg-primary-dark transition duration-150 primary-action-btn">
                    + Add New Client
                </button>
            </div>

            <div id="client-actions-card" class="bg-white p-6 rounded-xl corporate-card-pro flex flex-col justify-between dark:bg-[#252A31] dark:border-[#3A404A]">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b border-gray-200 pb-3 dark:text-[#EAEAEA] dark:border-[#3A404A]">üîß Client Actions</h2>
                <div class="space-y-3">
                    <button onclick="renameClient()" id="rename-client-btn" class="w-full bg-gray-500 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-600 transition duration-150 client-dependent-btn">
                        Rename Client
                    </button>
                    <button onclick="deleteClient()" id="delete-client-btn" class="w-full bg-danger text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-150 client-dependent-btn">
                        Delete Client
                    </button>
                </div>
            </div>
        </div>

        <div id="content-area-main-structure">
            <div id="content-display-header">
                <div class="flex justify-between items-center mb-6 mt-8">
                    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-[#EAEAEA]">
                        Client: <span id="active-client-display" class="text-primary dark:text-primary-light"></span>
                    </h2>
                </div>

                <div class="bg-white p-6 rounded-xl corporate-card-pro dark:bg-[#252A31] dark:border-[#3A404A]">
                    <h3 class="text-xl font-bold text-gray-800 mb-5 border-b border-gray-100 pb-3 dark:text-[#EAEAEA] dark:border-[#3A404A]">üìä Financial Overview</h3>
                    <div id="summary-results"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div class="bg-white p-6 rounded-xl corporate-card-pro dark:bg-[#252A31] dark:border-[#3A404A]">
                        <h3 class="text-xl font-bold text-primary mb-5 border-b border-primary/20 pb-3 flex items-center dark:text-primary-light dark:border-primary/30">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            Task Entry
                        </h3>
                        <div class="space-y-5">
                            <label class="block text-sm font-medium text-gray-700 dark:text-[#9A9A9A]">Time Duration (Hr:Min:Sec)</label>
                            <div class="grid grid-cols-3 gap-3">
                                <input type="number" id="task-hr-input" placeholder="Hr" class="client-dependent-input block w-full rounded-lg border-gray-300 shadow-sm p-3 text-center text-lg font-mono dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]" min="0">
                                <input type="number" id="task-min-input" placeholder="Min" class="client-dependent-input block w-full rounded-lg border-gray-300 shadow-sm p-3 text-center text-lg font-mono dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]" min="0" max="59">
                                <input type="number" id="task-sec-input" placeholder="Sec" class="client-dependent-input block w-full rounded-lg border-gray-300 shadow-sm p-3 text-center text-lg font-mono dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]" min="0" max="59">
                            </div>
                        </div>
                        <button onclick="addTask()" class="client-dependent-btn primary-action-btn mt-6 w-full bg-primary text-white font-extrabold py-3.5 rounded-lg shadow-xl hover:bg-primary-dark transition duration-150">
                            ADD BILLED TIME
                        </button>
                    </div>

                    <div class="bg-white p-6 rounded-xl corporate-card-pro dark:bg-[#252A31] dark:border-[#3A404A]">
                        <h3 class="text-xl font-bold text-accent mb-5 border-b border-accent/20 pb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                            Payment Entry
                        </h3>
                        <div class="space-y-5">
                            <div>
                                <label for="payment-amount-input" class="block text-sm font-medium text-gray-700 dark:text-[#9A9A9A]">Deposit Amount (‚Çπ)</label>
                                <input type="number" id="payment-amount-input" placeholder="‚Çπ 0.00" class="client-dependent-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 text-xl font-extrabold text-accent dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-accent-light dark:placeholder-[#7A7A7A]" min="0">
                            </div>
                        </div>
                        <button onclick="addPayment()" class="client-dependent-btn primary-action-btn mt-6 w-full bg-accent text-white font-extrabold py-3.5 rounded-lg shadow-xl hover:bg-emerald-700 transition duration-150">
                            ADD DEPOSIT
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl corporate-card-pro mt-8 dark:bg-[#252A31] dark:border-[#3A404A]">
                    <h3 class="text-xl font-bold text-gray-800 mb-5 border-b border-gray-200 pb-3 flex items-center dark:text-[#EAEAEA] dark:border-[#3A404A]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        Billing & Utility Actions
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="col-span-1 md:col-span-3">
                            <label for="hourly-rate-input" class="block text-sm font-medium text-gray-700 dark:text-[#9A9A9A]">Current Hourly Rate (‚Çπ)</label>
                            <input type="number" id="hourly-rate-input" class="client-dependent-input mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 text-lg font-bold dark:bg-[#3A404A] dark:border-[#4A505A] dark:text-[#EAEAEA] dark:placeholder-[#7A7A7A]" min="1">
                        </div>
                        <button onclick="updateHourlyRate()" class="client-dependent-btn primary-action-btn bg-primary/80 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-primary-dark transition duration-150">
                            Update Rate
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center dark:text-[#EAEAEA]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Task History
                        </h3>
                        <div id="task-list" class="history-list corporate-card-pro bg-white dark:bg-[#252A31] dark:border-[#3A404A]"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center dark:text-[#EAEAEA]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>
                            Payment History
                        </h3>
                        <div id="payment-list" class="history-list corporate-card-pro bg-white dark:bg-[#252A31] dark:border-[#3A404A]"></div>
                    </div>
                </div>
            </div>
            <div id="welcome-message" class="text-center p-10 bg-white rounded-xl corporate-card-pro mt-8 dark:bg-[#252A31] dark:border-[#3A404A]" style="display:none;">
            </div>
        </div>
    </div>
</div>

<button id="scroll-to-top" class="circular-button bg-primary text-white transition duration-150 transform hover:scale-110 focus:ring-4 focus:ring-primary/50">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
    </svg>
</button>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script>
    // --- CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyCG9w-pUJq9FopmIUUPLUVMc03P84Rblgw",
      authDomain: "jar-ledger.firebaseapp.com",
      databaseURL: "https://jar-ledger-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "jar-ledger",
      storageBucket: "jar-ledger.firebasestorage.app",
      messagingSenderId: "915159281904",
      appId: "1:915159281904:web:4f3d5c940a03c4b525d235",
      measurementId: "G-YB740FJBBG"
    };

    let database;
    let auth;
    //let clientLedgersRef = null;
    //let currentUserId = null;
    let isLoginMode = true;

    const DEFAULT_CLIENT_NAME = 'Default Client';

    // Local Storage Data
    let localDefaultClientData = JSON.parse(localStorage.getItem('jarLocalDefaultClient')) || {
        tasks: [], payments: [], settings: { hourlyRate: 150 }
    };

    // Guest Data
    let tempGuestData = {
        activeClientName: DEFAULT_CLIENT_NAME,
        clients: {
            [DEFAULT_CLIENT_NAME]: { tasks: [], payments: [], settings: { hourlyRate: 150 } }
        }
    };

    let clientLedgers = { ...tempGuestData };
    let isFirebaseReady = false;

    const loginIconPath = "M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1";
    const userIconPath = "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z";

    // --- INITIALIZATION ---
    try {
         firebase.initializeApp(firebaseConfig);
         database = firebase.database();
         auth = firebase.auth();
         isFirebaseReady = true;
    } catch (e) {
         console.error("Firebase Initialization Error:", e);
         document.getElementById('auth-modal-backdrop').style.display = 'none';
         document.getElementById('app-content-area').style.display = 'block';
         document.getElementById('content-area-main-structure').innerHTML = `<h2 class="text-2xl font-bold text-danger mb-3">FATAL ERROR: Initialization Failed!</h2><p class="text-gray-600">Check console and configuration details.</p>`;
    }

    // --- THEME MANAGEMENT ---
    const themes = {
        light: { icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />', text: 'Light' },
        dark: { icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />', text: 'Dark' },
        system: { icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />', text: 'System' }
    };
    const themeCycle = ['system', 'light', 'dark'];

    function setTheme(theme) {
        localStorage.setItem('theme', theme);
        if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        updateSingleThemeButtonUI(theme);
    }

    function updateSingleThemeButtonUI(theme) {
        const btnIcon = document.getElementById('theme-toggle-icon');
        const btnText = document.getElementById('theme-toggle-text');
        if (btnIcon && btnText && themes[theme]) {
            btnIcon.innerHTML = themes[theme].icon;
            btnText.textContent = themes[theme].text;
        } else if (btnIcon && btnText) {
            btnIcon.innerHTML = themes.system.icon;
            btnText.textContent = themes.system.text;
        }
    }

    function toggleTheme() {
        const currentTheme = localStorage.getItem('theme') || 'system';
        const currentIndex = themeCycle.indexOf(currentTheme);
        const nextIndex = (currentIndex + 1) % themeCycle.length;
        setTheme(themeCycle[nextIndex]);
    }

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        const savedTheme = localStorage.getItem('theme') || 'system';
        if (savedTheme === 'system') setTheme('system');
    });

    // --- AUTH UI ---
    const showAuthModal = () => { isLoginMode = true; updateAuthFormUI(); document.getElementById('auth-modal-backdrop').style.display = 'flex'; };
    const hideAuthModal = () => { document.getElementById('auth-modal-backdrop').style.display = 'none'; };
    const toggleProfileDropdown = () => {
        const dropdown = document.getElementById('profile-dropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    };

    const updateAuthFormUI = () => {
        const title = document.getElementById('auth-title');
        const submitBtn = document.getElementById('auth-submit-btn');
        const toggleText = document.getElementById('auth-toggle-text');
        const toggleLink = document.getElementById('auth-toggle-link');
        if (isLoginMode) {
            title.textContent = 'Cloud Ledger Login'; submitBtn.textContent = 'Log In';
            submitBtn.classList.add('bg-primary'); submitBtn.classList.remove('bg-accent');
            toggleText.textContent = 'Need an account?'; toggleLink.textContent = 'Sign Up';
        } else {
            title.textContent = 'Create New Account'; submitBtn.textContent = 'Sign Up';
            submitBtn.classList.add('bg-accent'); submitBtn.classList.remove('bg-primary');
            toggleText.textContent = 'Already have an account?'; toggleLink.textContent = 'Log In';
        }
    };

    // --- AUTH LOGIC ---
    const submitAuthForm = () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        if (!email || !password) { alert("Please enter both email and password."); return; }
        if (isLoginMode) {
            auth.signInWithEmailAndPassword(email, password).catch(error => alert(`Login Failed: ${error.message}`));
        } else {
            auth.createUserWithEmailAndPassword(email, password).then(() => alert("Sign Up Successful! Please log in.")).catch(error => alert(`Sign Up Failed: ${error.message}`));
        }
    };
         // Sign in with logic
    const signInWithGoogle = () => {
        const provider = new firebase.auth.GoogleAuthProvider();

        // Logic to detect if running in Android App or Browser
        // 1. Check for 'AndroidApp' interface (Jo aapke logout function me bhi use hua hai)
        // 2. Check UserAgent for 'wv' (WebView) indicating an Android wrapper
        const isApp = (typeof window.AndroidApp !== 'undefined') || /Android.*wv/.test(navigator.userAgent);

        if (isApp) {
            // Agar App hai to Redirect use karega
            console.log("Detected App environment: Using signInWithRedirect");
            auth.signInWithRedirect(provider);
        } else {
            // Agar Website hai to Popup use karega
            console.log("Detected Web environment: Using signInWithPopup");
            auth.signInWithPopup(provider).catch((error) => {
                console.error("Popup Error:", error);
                alert(error.message);
            });
        }
    };

    const logout = () => {
    // 1. Dropdown band karo
    toggleProfileDropdown();

    // 2. Agar Android App mein hain, toh wahan ki cookies saaf karo
    if (window.AndroidApp && window.AndroidApp.clearAppCookies) {
        window.AndroidApp.clearAppCookies();
    }

    // 3. Firebase se logout karo
    auth.signOut().then(() => {
        // 4. Reload karo taaki Google ka purana session puri tarah hat jaye
        location.reload();
    }).catch(error => console.error("Logout Error:", error));
};

    // --- HELPER ---
    const updateCardVisibility = () => {
        const selectClientCard = document.getElementById('select-client-card');
        const newClientCard = document.getElementById('new-client-card');
        const clientActionsCard = document.getElementById('client-actions-card');
        let showSelect = true, showActions = true, showNew = true;

        if (!currentUserId) { showSelect = true; showActions = true; }
        else if (clientLedgers.activeClientName === DEFAULT_CLIENT_NAME) { showSelect = true; showActions = false; }

        selectClientCard.style.display = showSelect ? 'block' : 'none';
        clientActionsCard.style.display = showActions ? 'flex' : 'none';
        newClientCard.style.display = showNew ? 'flex' : 'none';
    }

    // --- AUTH STATE ---
    auth.onAuthStateChanged(user => {
        const appContent = document.getElementById('app-content-area');
        const authModal = document.getElementById('auth-modal-backdrop');
        const userActionContainer = document.getElementById('user-action-container');
        const userActionButton = document.getElementById('user-action-button');
        const userActionIcon = document.getElementById('user-action-icon');
        const profileDropdown = document.getElementById('profile-dropdown');
        const userEmailDisplay = document.getElementById('user-email-display');

        userActionContainer.style.display = 'block';

        if (user) {
            currentUserId = user.uid;
            appContent.style.display = 'block';
            authModal.style.display = 'none';
            profileDropdown.style.display = 'none';
            userActionIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="${userIconPath}" />`;
            userActionButton.style.backgroundColor = 'var(--tw-colors-primary)';
            userActionButton.title = 'Profile & Settings';
            userActionButton.onclick = toggleProfileDropdown;
            userEmailDisplay.textContent = user.email || 'Cloud User';

            localDefaultClientData = JSON.parse(localStorage.getItem('jarLocalDefaultClient')) || { tasks: [], payments: [], settings: { hourlyRate: 150 } };
            clientLedgersRef = database.ref(`users/${currentUserId}/clientLedgers`);
            startRealtimeListener();
        } else {
            currentUserId = null;
            clientLedgersRef = null;
            appContent.style.display = 'block';
            authModal.style.display = 'none';
            profileDropdown.style.display = 'none';
            userActionIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="${loginIconPath}" />`;
            userActionButton.style.backgroundColor = 'var(--tw-colors-accent)';
            userActionButton.title = 'Log In / Sync';
            userActionButton.onclick = showAuthModal;
            tempGuestData = { activeClientName: DEFAULT_CLIENT_NAME, clients: { [DEFAULT_CLIENT_NAME]: { tasks: [], payments: [], settings: { hourlyRate: 150 } } } };
            clientLedgers = { ...tempGuestData };
            renderAllClientData();
        }
    });

    // --- DATA OPERATIONS ---
    const saveLocalData = () => {
        if (!currentUserId) { console.log("Guest mode: No local save"); return; }
        if (clientLedgers.clients[DEFAULT_CLIENT_NAME]) {
            localStorage.setItem('jarLocalDefaultClient', JSON.stringify(clientLedgers.clients[DEFAULT_CLIENT_NAME]));
        }
    }

    const saveDataToCloud = () => {
         if (!clientLedgersRef || !isFirebaseReady || !currentUserId) return;
         const dataToSave = JSON.parse(JSON.stringify(clientLedgers));
         delete dataToSave.clients[DEFAULT_CLIENT_NAME];
         clientLedgersRef.set(dataToSave).catch((error) => {
                 console.error("Error saving data to Firebase:", error);
                 alert("Error: Could not save data. Check Firebase Rules and connection.");
         });
    };

    const initializeDefaultClient = () => {
         if (!clientLedgers.activeClientName || !clientLedgers.clients[clientLedgers.activeClientName]) {
             if (currentUserId) {
                const firstCloudClient = Object.keys(clientLedgers.clients).filter(name => name !== DEFAULT_CLIENT_NAME).sort()[0];
                clientLedgers.activeClientName = firstCloudClient || DEFAULT_CLIENT_NAME;
             } else {
                clientLedgers.activeClientName = DEFAULT_CLIENT_NAME;
             }
         }
    };

    const startRealtimeListener = () => {
         if (!clientLedgersRef || !isFirebaseReady) return;
         const welcomeMessage = document.getElementById('welcome-message');
         const contentHeader = document.getElementById('content-display-header');
         contentHeader.style.display = 'none';
         welcomeMessage.style.display = 'block';
         welcomeMessage.innerHTML = `<h2 class="text-2xl font-bold text-primary mb-3 dark:text-primary-light">Loading Data...</h2><p class="text-gray-600 dark:text-[#9A9A9A]">Please wait while the application connects to the cloud database.</p>`;

         clientLedgersRef.on('value', (snapshot) => {
             const data = snapshot.val();
             if (data && data.clients) {
                 if (data.clients[DEFAULT_CLIENT_NAME]) {
                     database.ref(`users/${currentUserId}/clientLedgers/clients/${DEFAULT_CLIENT_NAME}`).remove();
                     delete data.clients[DEFAULT_CLIENT_NAME];
                 }
                 clientLedgers.clients = data.clients || {};
                 clientLedgers.activeClientName = data.activeClientName || null;
             } else {
                 clientLedgers = { activeClientName: null, clients: {} };
             }
             clientLedgers.clients[DEFAULT_CLIENT_NAME] = localDefaultClientData;
             initializeDefaultClient();
             renderAllClientData();
         }, (error) => {
             console.error("Firebase Read Failed:", error);
             welcomeMessage.innerHTML = `<h2 class="text-2xl font-bold text-danger mb-3">ERROR: Data Load Failed!</h2><p class="text-gray-600 dark:text-[#9A9A9A]">Please check your Firebase Rules or network connection.</p>`;
         });
    };

    const getOrCreateClientData = (clientName) => {
        if (!clientLedgers.clients[clientName]) {
            clientLedgers.clients[clientName] = { tasks: [], payments: [], settings: { hourlyRate: 150 } };
        }
        if (clientName === DEFAULT_CLIENT_NAME) saveLocalData();
        return clientLedgers.clients[clientName];
    };

    const decimalHoursToHMS = (decimalHours) => {
        const totalSeconds = Math.round(decimalHours * 3600);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours}h ${minutes}m ${seconds}s`;
    };

    const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 }).format(amount).replace('‚Çπ', '‚Çπ');
    const formatDate = (dateString) => { const d = new Date(dateString); return isNaN(d) ? 'Invalid Date' : d.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }); };

    const handleClientSelectionChange = (event) => { clientLedgers.activeClientName = event.target.value; saveDataToCloud(); renderAllClientData(); };

    const addNewClient = () => {
        let newClientName = prompt("Enter New Client Name:");
        if (newClientName && newClientName.trim() !== "") {
            newClientName = newClientName.trim();
            if (newClientName === DEFAULT_CLIENT_NAME) { alert("Reserved name."); return; }
            if (clientLedgers.clients[newClientName]) { alert("Exists already."); return; }
            if (!currentUserId) alert("Guest Mode: Data lost on refresh.");
            getOrCreateClientData(newClientName);
            clientLedgers.activeClientName = newClientName;
            saveLocalData(); saveDataToCloud(); renderAllClientData();
        }
    };

    const renameClient = () => {
        const oldName = clientLedgers.activeClientName;
        if (!oldName || oldName === DEFAULT_CLIENT_NAME) return;
        let newName = prompt(`Rename "${oldName}" to:`);
        if (newName && newName.trim() !== "" && newName.trim() !== oldName) {
            newName = newName.trim();
            if (newName === DEFAULT_CLIENT_NAME || clientLedgers.clients[newName]) return;
            clientLedgers.clients[newName] = clientLedgers.clients[oldName];
            delete clientLedgers.clients[oldName];
            clientLedgers.activeClientName = newName;
            saveLocalData(); saveDataToCloud(); renderAllClientData();
        }
    };

    const deleteClient = () => {
        const clientToDelete = clientLedgers.activeClientName;
        if (!clientToDelete || clientToDelete === DEFAULT_CLIENT_NAME) return;
        if (!confirm(`Delete "${clientToDelete}" and all data?`)) return;
        delete clientLedgers.clients[clientToDelete];
        initializeDefaultClient(); saveLocalData(); saveDataToCloud(); renderAllClientData();
    };

    const addTask = () => {
        const hr = parseFloat(document.getElementById('task-hr-input').value) || 0;
        const min = parseFloat(document.getElementById('task-min-input').value) || 0;
        const sec = parseFloat(document.getElementById('task-sec-input').value) || 0;
        if (hr === 0 && min === 0 && sec === 0) return;

        const clientData = getOrCreateClientData(clientLedgers.activeClientName);
        if (!Array.isArray(clientData.tasks)) clientData.tasks = Object.values(clientData.tasks || {});

        clientData.tasks.push({
            hours: hr, minutes: min, seconds: sec,
            decimalHours: hr + (min / 60) + (sec / 3600),
            date: new Date().toISOString().split('T')[0],
            timestamp: Date.now()
        });

        document.getElementById('task-hr-input').value = '';
        document.getElementById('task-min-input').value = '';
        document.getElementById('task-sec-input').value = '';
        saveLocalData(); saveDataToCloud(); renderAllClientData();
    };

    const addPayment = () => {
        const amount = parseFloat(document.getElementById('payment-amount-input').value);
        if (isNaN(amount) || amount <= 0) return;
        const clientData = getOrCreateClientData(clientLedgers.activeClientName);
        if (!Array.isArray(clientData.payments)) clientData.payments = Object.values(clientData.payments || {});
        clientData.payments.push({ amount: amount, date: new Date().toISOString().split('T')[0], timestamp: Date.now() });
        document.getElementById('payment-amount-input').value = '';
        saveLocalData(); saveDataToCloud(); renderAllClientData();
    };

    const updateHourlyRate = () => {
        const newRate = parseFloat(document.getElementById('hourly-rate-input').value);
        if (isNaN(newRate) || newRate <= 0) return;
        const clientData = getOrCreateClientData(clientLedgers.activeClientName);
        clientData.settings.hourlyRate = newRate;
        saveLocalData(); saveDataToCloud(); renderAllClientData();
    };

    const handleDelete = (type, timestamp) => {
        if (!confirm(`Delete this entry?`)) return;
        const clientData = getOrCreateClientData(clientLedgers.activeClientName);
        const list = type === 'task' ? 'tasks' : 'payments';
        if (!Array.isArray(clientData[list])) clientData[list] = Object.values(clientData[list] || {});
        clientData[list] = clientData[list].filter(item => item.timestamp !== timestamp);
        saveLocalData(); saveDataToCloud(); renderAllClientData();
    };

    // --- RENDER ---
    const calculateClientSummary = (clientData) => {
        const tasks = Array.isArray(clientData.tasks) ? clientData.tasks : Object.values(clientData.tasks || {});
        const payments = Array.isArray(clientData.payments) ? clientData.payments : Object.values(clientData.payments || {});
        const totalHours = tasks.reduce((sum, t) => sum + t.decimalHours, 0);
        const totalTaskValue = totalHours * clientData.settings.hourlyRate;
        const totalDeposited = payments.reduce((sum, p) => sum + p.amount, 0);
        return { totalHours, totalTaskValue, totalDeposited, remainingBalance: totalTaskValue - totalDeposited };
    };

    const renderClientSelector = () => {
        const selector = document.getElementById('client-selector');
        const filterText = document.getElementById('client-search-input').value.toLowerCase().trim();
        selector.innerHTML = '';

        const cloudClients = Object.keys(clientLedgers.clients).filter(name => name !== DEFAULT_CLIENT_NAME).sort();
        let allClientNames = [DEFAULT_CLIENT_NAME, ...cloudClients];
        if (!currentUserId) allClientNames = Object.keys(clientLedgers.clients).sort();

        const filteredClients = allClientNames.filter(name => name.toLowerCase().includes(filterText));
        if (filteredClients.length === 0) selector.innerHTML = '<option disabled selected>No clients found</option>';

        filteredClients.forEach(name => {
            const option = document.createElement('option');
            option.value = name; option.textContent = name;
            if (name === clientLedgers.activeClientName) option.selected = true;
            selector.appendChild(option);
        });

        const isActionable = clientLedgers.activeClientName && clientLedgers.activeClientName !== DEFAULT_CLIENT_NAME;
        document.getElementById('rename-client-btn').disabled = !isActionable;
        document.getElementById('delete-client-btn').disabled = !isActionable;
        document.getElementById('rename-client-btn').classList.toggle('client-action-disabled', !isActionable);
        document.getElementById('delete-client-btn').classList.toggle('client-action-disabled', !isActionable);
    };

    const renderSummary = (summary, hourlyRate) => {
        const isNegative = summary.remainingBalance < 0;
        const balanceClass = isNegative ? 'text-danger bg-red-50 border-danger net-balance-highlight dark:bg-red-900/50 dark:border-red-700' : 'text-accent bg-green-50 border-accent net-balance-highlight dark:bg-green-900/50 dark:border-green-700';
        const balanceLabel = isNegative ? 'Amount Due' : 'Client Credit';
        const balanceTextColor = isNegative ? 'text-danger' : 'text-accent';

        document.getElementById('summary-results').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="p-4 bg-white rounded-lg corporate-card-pro border border-gray-100 dark:bg-[#252A31] dark:border-[#3A404A]"><p class="text-xs font-semibold text-gray-500 uppercase dark:text-[#9A9A9A]">Hourly Rate</p><p class="text-3xl font-extrabold text-primary-dark dark:text-primary-light mt-1">${formatCurrency(hourlyRate)}</p></div>
                <div class="p-4 bg-white rounded-lg corporate-card-pro border border-gray-100 dark:bg-[#252A31] dark:border-[#3A404A]"><p class="text-xs font-semibold text-gray-500 uppercase dark:text-[#9A9A9A]">Total Hours</p><p class="text-3xl font-extrabold text-primary-dark dark:text-primary-light mt-1">${decimalHoursToHMS(summary.totalHours)}</p></div>
                <div class="p-4 bg-white rounded-lg corporate-card-pro border border-gray-100 dark:bg-[#252A31] dark:border-[#3A404A]"><p class="text-xs font-semibold text-gray-500 uppercase dark:text-[#9A9A9A]">Total Billed</p><p class="text-3xl font-extrabold text-gray-800 dark:text-[#EAEAEA] mt-1">${formatCurrency(summary.totalTaskValue)}</p></div>
                <div class="p-4 rounded-lg corporate-card-pro border-2 ${balanceClass}"><p class="text-xs font-semibold ${balanceTextColor} uppercase">Net Balance</p><p class="text-4xl font-extrabold ${balanceTextColor} mt-1">${formatCurrency(Math.abs(summary.remainingBalance))}</p><p class="text-sm font-semibold ${balanceTextColor} mt-1">${balanceLabel}</p></div>
            </div>
            <div class="mt-5 p-3 bg-white border border-gray-200 rounded-lg shadow-sm text-center dark:bg-[#252A31] dark:border-[#3A404A]"><p class="text-sm font-semibold text-gray-600 dark:text-[#9A9A9A]">Total Deposit: <span class="text-xl font-bold text-accent">${formatCurrency(summary.totalDeposited)}</span></p></div>`;
    };

    const renderTaskList = (tasks, hourlyRate, activeClientName) => {
        const listEl = document.getElementById('task-list'); listEl.innerHTML = '';
        const tArr = Array.isArray(tasks) ? tasks : Object.values(tasks || {});
        const sorted = [...tArr].sort((a, b) => b.timestamp - a.timestamp);

        if (sorted.length === 0) { listEl.innerHTML = '<p class="text-center text-gray-500 dark:text-[#9A9A9A] p-4">No Task entries found.</p>'; return; }
        sorted.forEach((task, idx) => {
            const item = document.createElement('div');
            item.className = 'list-item p-4 bg-white border-b border-gray-100 hover:bg-gray-50 dark:bg-[#252A31] dark:border-[#3A404A] dark:hover:bg-[#3A404A] flex justify-between items-center transition';
            item.innerHTML = `
                <div class="flex-grow"><p class="text-base font-semibold text-gray-800 dark:text-[#EAEAEA]"><span class="text-primary dark:text-primary-light font-bold mr-3">${tArr.length - idx}.</span><span class="font-extrabold text-primary dark:text-primary-light">${activeClientName}</span> <span class="ml-4 text-sm">Billed: ${formatCurrency(task.decimalHours * hourlyRate)}</span></p><p class="text-xs text-gray-500 dark:text-[#9A9A9A] mt-1 ml-6">Time: ${task.hours}h ${task.minutes}m ${task.seconds}s ‚Ä¢ ${formatDate(task.date)}</p></div>
                <button onclick="handleDelete('task', ${task.timestamp})" class="text-danger p-1 rounded-full"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
            listEl.appendChild(item);
        });
    };

    const renderPaymentList = (payments, hourlyRate, activeClientName) => {
        const listEl = document.getElementById('payment-list'); listEl.innerHTML = '';
        const pArr = Array.isArray(payments) ? payments : Object.values(payments || {});
        const sorted = [...pArr].sort((a, b) => b.timestamp - a.timestamp);

        if (sorted.length === 0) { listEl.innerHTML = '<p class="text-center text-gray-500 dark:text-[#9A9A9A] p-4">No Payment entries found.</p>'; return; }
        sorted.forEach((payment, idx) => {
            const item = document.createElement('div');
            item.className = 'list-item p-4 bg-white border-b border-gray-100 hover:bg-gray-50 dark:bg-[#252A31] dark:border-[#3A404A] dark:hover:bg-[#3A404A] flex justify-between items-center transition';
            item.innerHTML = `
                <div class="flex-grow"><p class="text-base font-semibold text-gray-800 dark:text-[#EAEAEA]"><span class="text-primary dark:text-primary-light font-bold mr-3">${pArr.length - idx}.</span>Amount Received: <span class="font-extrabold text-accent ml-2">${formatCurrency(payment.amount)}</span></p><p class="text-xs text-gray-500 dark:text-[#9A9A9A] mt-1 ml-6">Date: ${formatDate(payment.date)}</p></div>
                <button onclick="handleDelete('payment', ${payment.timestamp})" class="text-danger p-1 rounded-full"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
            listEl.appendChild(item);
        });
    };

    const renderAllClientData = () => {
        updateCardVisibility(); renderClientSelector();
        const activeClientName = clientLedgers.activeClientName;
        const clientData = activeClientName ? clientLedgers.clients[activeClientName] : null;

        const welcomeMessage = document.getElementById('welcome-message');
        const contentHeader = document.getElementById('content-display-header');

        if (!activeClientName || !clientData) {
             contentHeader.style.display = 'none'; welcomeMessage.style.display = 'block';
             welcomeMessage.innerHTML = `<h2 class="text-2xl font-bold text-primary mb-3">Loading...</h2>`;
             if (!activeClientName && clientLedgers.clients[DEFAULT_CLIENT_NAME]) clientLedgers.activeClientName = DEFAULT_CLIENT_NAME;
             return;
        }

        if (currentUserId && activeClientName === DEFAULT_CLIENT_NAME) {
            contentHeader.style.display = 'none'; welcomeMessage.style.display = 'block';
            welcomeMessage.innerHTML = `<h2 class="text-2xl font-bold text-primary mb-3 dark:text-primary-light">Welcome!</h2><p class="text-gray-600 dark:text-[#9A9A9A]">You are viewing your local <b>Default Client</b>. Data saved to device.<br>Select a cloud client to view ledger.</p>`;
        } else {
            contentHeader.style.display = 'block'; welcomeMessage.style.display = 'none';
            const inputsEnabled = !!activeClientName;
            document.querySelectorAll('.client-dependent-input, .client-dependent-btn').forEach(el => el.disabled = !inputsEnabled);
            const summary = calculateClientSummary(clientData);
            document.getElementById('active-client-display').textContent = activeClientName;
            document.getElementById('hourly-rate-input').value = clientData.settings.hourlyRate;
            renderSummary(summary, clientData.settings.hourlyRate);
            renderTaskList(clientData.tasks, clientData.settings.hourlyRate, activeClientName);
            renderPaymentList(clientData.payments, clientData.settings.hourlyRate, activeClientName);
        }
    };

    // --- EVENTS ---
    window.onload = () => {
        document.getElementById('client-selector').addEventListener('change', handleClientSelectionChange);
        document.getElementById('client-search-input').addEventListener('input', renderClientSelector);
        document.getElementById('auth-modal-backdrop').addEventListener('click', hideAuthModal);
        document.getElementById('auth-submit-btn').addEventListener('click', submitAuthForm);
        document.getElementById('auth-toggle-link').addEventListener('click', () => { isLoginMode = !isLoginMode; updateAuthFormUI(); });
        document.getElementById('add-new-client-btn').addEventListener('click', addNewClient);
        document.getElementById('dropdown-logout-btn').addEventListener('click', logout);
        document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);

        window.addEventListener('click', (e) => {
            if (document.getElementById('user-action-container') && !document.getElementById('user-action-container').contains(e.target)) {
                document.getElementById('profile-dropdown').style.display = 'none';
            }
        });

        updateSingleThemeButtonUI(localStorage.getItem('theme') || 'system');

        // Scroll Top
        const scrollTopBtn = document.getElementById('scroll-to-top');
        if (scrollTopBtn) {
            window.onscroll = () => { scrollTopBtn.style.display = (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) ? "flex" : "none"; };
            scrollTopBtn.onclick = () => window.scrollTo({top: 0, behavior: 'smooth'});
        }
    };
</script>
</body>
</html>
